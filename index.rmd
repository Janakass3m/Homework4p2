---
title: "Homework4p2"
output: html_document
date: "2025-10-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars}
library(tidyverse)
library(lubridate)
library(randomForest)   # fast, strong baseline
library(pROC)           # threshold tuning on training

test <- read.csv("test_dataset.csv.gz")
train <- read.csv("train_dataset.csv.gz")
```

```{r}
featurize <- function(df) {
  df %>%
    mutate(
      lead_time_days = as.numeric(as_datetime(appt_time) - as_datetime(appt_made), units = "days"),
      appt_hour      = factor(hour(as_datetime(appt_time))),
      dow            = factor(wday(as_datetime(appt_time), label = TRUE, week_start = 1)),
      is_weekend     = wday(as_datetime(appt_time), week_start = 1) %in% c(6,7)
    ) %>%
    mutate(
      address   = factor(address),
      specialty = factor(specialty),
      provider_id = factor(provider_id),
      id          = factor(id)
    )
}

train_x <- featurize(train)
test_x  <- featurize(test)

# Model matrix (exclude target)
model_vars <- c("provider_id","address","age","specialty",
                "lead_time_days","appt_hour","dow","is_weekend")
train_x <- train_x %>% select(all_of(model_vars), no_show)
test_x  <- test_x  %>% select(all_of(model_vars), no_show)

```


```{r}
set.seed(24)
rf <- randomForest(
  x = train_x %>% select(-no_show),
  y = factor(train_x$no_show),
  ntree = 500,
  mtry = floor(sqrt(ncol(train_x)-1)),
  nodesize = 5
)

# Probabilities on training
train_p <- as.numeric(predict(rf, newdata = train_x, type = "prob")[, "1"])

```

```{r}

search_thresh <- function(y_true, p_hat) {
  cand <- seq(0.05, 0.95, by = 0.01)
  errs <- sapply(cand, function(t) mean( (p_hat >= t) != as.logical(y_true) ))
  cand[which.min(errs)]
}
t_star <- search_thresh(train_x$no_show, train_p)
t_star

```

```{r}
test_p <- as.numeric(predict(rf, newdata = test_x, type = "prob")[, "1"])
test_pred <- as.integer(test_p >= t_star)
overall_error <- mean(test_pred != test_x$no_show)
overall_error

```

```{r}
# --- Build a predictions table that keeps appt_time (and other useful cols) ---
test_feats <- featurize(test)

# probabilities (using the same order as test_feats)
test_p    <- as.numeric(predict(rf, newdata = test_feats %>% select(all_of(model_vars)), type = "prob")[, "1"])
test_pred <- as.integer(test_p >= t_star)

preds_out <- test_feats %>%
  mutate(prob_no_show = test_p,
         pred_no_show = test_pred) %>%
  # keep only what the Shiny app needs
  select(appt_time, provider_id, address, age, specialty, prob_no_show, pred_no_show)

# write the file the app will read
readr::write_csv(preds_out, "test_with_predictions.csv")
saveRDS(rf, "model_rf.rds")

```


